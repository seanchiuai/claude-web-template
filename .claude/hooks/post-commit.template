#!/bin/bash
#
# Post-commit hook: Queue expert self-improvement for significant changes
# Part of Agent Experts system - enables automatic learning
#

PENDING_FILE=".claude/pending-syncs.txt"
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Track which experts need sync
SYNC_CONVEX=false
SYNC_NEXTJS=false
SYNC_SHADCN=false
SYNC_VERCEL=false

while IFS= read -r file; do
  case "$file" in
    convex/*.ts) SYNC_CONVEX=true ;;
    app/*.tsx|app/*.ts|app/**/*.tsx|app/**/*.ts) SYNC_NEXTJS=true ;;
    components/*.tsx|components/**/*.tsx)
      [[ "$file" =~ components/ui/ ]] && SYNC_SHADCN=true || SYNC_NEXTJS=true ;;
    app/globals.css|tailwind.config.ts|components.json) SYNC_SHADCN=true ;;
    next.config.ts|vercel.json|.env.example) SYNC_VERCEL=true ;;
  esac
done <<< "$CHANGED_FILES"

# Write pending syncs to file (append, dedupe later)
PENDING=""
[ "$SYNC_CONVEX" = true ] && PENDING="$PENDING convex"
[ "$SYNC_NEXTJS" = true ] && PENDING="$PENDING nextjs"
[ "$SYNC_SHADCN" = true ] && PENDING="$PENDING shadcn"
[ "$SYNC_VERCEL" = true ] && PENDING="$PENDING vercel"

if [ -n "$PENDING" ]; then
  # Create file if needed, append unique entries
  touch "$PENDING_FILE"
  for expert in $PENDING; do
    grep -qxF "$expert" "$PENDING_FILE" || echo "$expert" >> "$PENDING_FILE"
  done
  echo "� Queued for sync:$PENDING → .claude/pending-syncs.txt"
fi

exit 0
